<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
@import url("https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500&display=swap");

:root {
  --text-dark:#1b1b1b;
  --card-bg:#f0f0f0;
  --shadow:0 10px 25px rgba(0,0,0,0.25);
}

body {
  font-family:"SF Pro Display",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
  background:transparent;
}

/* WRAPPER */
.testimonial-wrap {
  position:relative;
  display:flex;
  justify-content:center;
  align-items:flex-end;
  perspective:1500px;
  padding:100px 0;
  overflow:visible !important;
  user-select:none;
  background:transparent !important;

  /* GPU pre-activation */
  transform: translateZ(0);
  will-change: transform, opacity;
  backface-visibility: hidden;
  isolation: isolate;
}

/* CARD */
.testimonial {
  width:260px;
  min-height:400px;
  border-radius:20px;
  box-shadow:var(--shadow);
  margin:0 -75px;
  cursor:pointer;
  transform-style:preserve-3d;
  position:relative;
  color:var(--text-dark);
  background:var(--card-bg);
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  align-items:flex-start;
  padding:40px 30px;
  text-align:left;
  transition:box-shadow .4s ease;
  z-index:1;
  pointer-events:auto;
  will-change:transform, opacity;
  isolation:isolate;

  /* start hidden for scroll-in */
  opacity:0;
  transform:translateY(60px) scale(0.9) translateZ(1px);
}

.testimonial::before {
  content:"";
  position:absolute;
  top:0;left:-75%;
  width:50%;height:100%;
  background:linear-gradient(120deg,rgba(255,255,255,.05),transparent);
  transform:skewX(-25deg);
  transition:all 1s ease;
  pointer-events:none;
}
.testimonial:hover::before { left:125%; }

/* TEXT */
.quote {
  font-size:1.9rem;
  line-height:1.4;
  font-weight:500;
  margin-bottom:25px;
  max-width:95%;
  letter-spacing:-0.01em;
}
.name { font-size:1.15rem; font-weight:400; }
.role { font-size:1rem; font-weight:400; opacity:0.7; }

.testimonial-wrap:focus { outline:none!important; }
</style>

<div class="testimonial-wrap" tabindex="-1">
  <div class="testimonial">
    <p class="quote">“Nate’s dedication and creativity made him an invaluable member of our team at MJR.”</p>
    <div class="name">Heather Talcott</div>
    <div class="role">Graphic Designer, MJR Theatres</div>
  </div>
  <div class="testimonial">
    <p class="quote">“Nathan’s creativity, reliability, and speed consistently impressed everyone at LPD.”</p>
    <div class="name">Josh Crowdrey</div>
    <div class="role">National Sales Manager, LPD Music</div>
  </div>
  <div class="testimonial">
    <p class="quote">“Nate always goes above and beyond. Reliable, talented, and a joy to collaborate with.”</p>
    <div class="name">Monika Zindulis</div>
    <div class="role">Graphic Designer</div>
  </div>
  <div class="testimonial">
    <p class="quote">“Nate’s openness to critique and constant curiosity make him a true asset in any design setting.”</p>
    <div class="name">Guneet Ghotra</div>
    <div class="role">Design Professor, Wayne State University</div>
  </div>
  <div class="testimonial">
    <p class="quote">“Nate’s creativity and positive energy elevate every project. Working with him is awesome.”</p>
    <div class="name">Hyelim Shin</div>
    <div class="role">Graphic Designer</div>
  </div>
</div>

<script>
function initTestimonials(){
  const ELASTIC_OUT = "elastic.out(1,0.6)";
  const SHADOW_IN   = "0 25px 60px rgba(0,0,0,0.4)";
  const SHADOW_BASE = "0 10px 25px rgba(0,0,0,0.25)";
  const LIFT_Y = -30, LIFT_Z = 65, SHIFT_X = 55, DIM_SCALE = 0.94;

  const wrap  = document.querySelector(".testimonial-wrap");
  if (!wrap) return;
  const cards = [...wrap.querySelectorAll(".testimonial")];
  const base  = [
    {r:-6,x:-50,y:15},
    {r:-3,x:-25,y:10},
    {r: 2,x:  0,y: 5},
    {r: 5,x: 25,y:10},
    {r:-3,x: 50,y:12},
  ];

  // reset opacity and transforms (for re-mounts too)
  gsap.set(cards, {opacity:0, y:60, scale:0.9});
  cards.forEach(c => { c.style.transform="translateZ(0)"; c.getBoundingClientRect(); });

  // initial stack positions
  cards.forEach((c,i)=>{
    gsap.set(c,{
      rotationX:0, rotationY:0, rotationZ:base[i].r,
      x:base[i].x, y:base[i].y, z:0,
      scale:1, filter:"brightness(1)", boxShadow:SHADOW_BASE
    });
  });

  let activeIndex=null;

  function layoutActive(idx){
    activeIndex=idx;
    cards.forEach((c,i)=>{
      gsap.killTweensOf(c);
      c.style.zIndex=(i===idx)?10:1;
      if(i===idx){
        gsap.to(c,{
          duration:0.6,
          rotationX:8,rotationY:4,rotationZ:0,
          x:base[i].x,y:LIFT_Y,z:LIFT_Z+40,
          scale:1.12,filter:"brightness(1)",
          boxShadow:SHADOW_IN,ease:ELASTIC_OUT,overwrite:"auto"
        });
      } else {
        const dir=i<idx?-1:1;
        const offset=(i===idx-1||i===idx+1)?SHIFT_X*1.5:SHIFT_X;
        gsap.to(c,{
          duration:0.55,
          rotationZ:base[i].r+(2*dir),
          x:base[i].x+(offset*dir),
          y:base[i].y+5,
          scale:DIM_SCALE,filter:"brightness(0.85)",
          boxShadow:SHADOW_BASE,ease:"power2.out",overwrite:"auto"
        });
      }
    });
  }

  function layoutRest(){
    activeIndex=null;
    cards.forEach((c,i)=>{
      gsap.killTweensOf(c);
      c.style.zIndex=1;
      gsap.to(c,{
        duration:0.6,
        rotationX:0,rotationY:0,rotationZ:base[i].r,
        x:base[i].x,y:base[i].y,z:0,
        scale:1,filter:"brightness(1)",
        boxShadow:SHADOW_BASE,ease:"power2.out",overwrite:"auto"
      });
    });
  }

  cards.forEach((card,idx)=>{
    card.addEventListener("pointerenter",()=>layoutActive(idx));
    card.addEventListener("pointermove",e=>{
      if(activeIndex!==idx)return;
      const r=card.getBoundingClientRect();
      const relX=e.clientX-r.left-r.width/2;
      const relY=e.clientY-r.top-r.height/2;
      gsap.to(card,{
        rotationX:-relY/25,
        rotationY:relX/25,
        duration:0.25,ease:"power2.out",overwrite:"auto"
      });
    });
  });
  wrap.addEventListener("pointerleave",layoutRest);

  // scroll in/out
  let lastY=window.scrollY,shown=false;
  function popIn(){
    if(shown)return;shown=true;
    gsap.to(cards,{opacity:1,y:0,scale:1,duration:0.8,ease:"power3.out",
      stagger:{each:0.18,from:"start"},overwrite:true});
  }
  function popOut(){
    if(!shown)return;shown=false;
    gsap.to(cards,{opacity:0,y:60,scale:0.9,duration:0.6,ease:"power2.in",
      stagger:{each:0.12,from:"end"},overwrite:true});
  }

  const io=new IntersectionObserver((entries)=>{
    const entry=entries[0];
    const scrollingDown=window.scrollY>lastY;
    lastY=window.scrollY;
    if(entry.isIntersecting){popIn();}
    else if(!scrollingDown){popOut();}
  },{root:null,threshold:0.25,rootMargin:"0px 0px -10% 0px"});
  io.observe(wrap);
}

/* -------- INITIALIZE ON LOAD -------- */
document.addEventListener("DOMContentLoaded", initTestimonials);

/* -------- RE-INIT ON WIX SPA REMOUNTS -------- */
const remountObserver = new MutationObserver(() => {
  const section = document.querySelector(".testimonial-wrap");
  if (section && !section.dataset.initialized) {
    section.dataset.initialized = "true";
    initTestimonials();
  }
});
remountObserver.observe(document.body, { childList:true, subtree:true });

/* -------- STRONG “WAKE-UP” FOR WIX PREVIEW -------- */
(function wakeWix() {
  let done = false;
  const wrap = document.querySelector(".testimonial-wrap");

  function nudge() {
    if (done || !wrap) return;
    done = true;

    // 1) tiny scroll jiggle over a few frames
    const y = window.scrollY;
    requestAnimationFrame(()=>window.scrollTo(0, y+1));
    requestAnimationFrame(()=>window.scrollTo(0, y));
    // 2) synthetic events that some sandboxes listen for
    window.dispatchEvent(new Event('scroll'));
    window.dispatchEvent(new Event('resize'));
    document.dispatchEvent(new Event('mousemove'));
    // 3) micro transform flip to force compositing
    wrap.style.transform = 'translateZ(0.0001px)';
    requestAnimationFrame(()=>{ wrap.style.transform = 'translateZ(0)'; });
  }

  // fire on any first real interaction OR after a short timeout
  ['mousemove','wheel','touchstart','pointermove','keydown','visibilitychange'].forEach(ev=>{
    window.addEventListener(ev, nudge, { once:true, passive:true });
  });
  // fallback timer (in case user doesn’t interact)
  setTimeout(nudge, 1800);
})();

// Resize the Wix iframe to match section height
if (window.frameElement) {
  const resize = () => {
    window.frameElement.style.height = document.body.scrollHeight + "px";
  };
  new ResizeObserver(resize).observe(document.body);
  resize();
}
</script>
